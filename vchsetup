#!/bin/bash

/bin/echo -n "OS type: "
case "$OSTYPE" in
  darwin*)  echo "OSX" ; export OSVER='OSX' ;; 
  linux*)   echo "LINUX" ; export OSVER='LINUX' ;;
  *)        echo "unknown: $OSTYPE" ; export OSVER='unknown' ;;
esac
echo

if [ ! $OSVER == 'OSX' ] && [ ! $(which ronn) ]; then
   echo "install ronn gem"
   exit 128
fi

APPLIST='myrepos vcsh git-crypt'

if [[ $OSVER == unknown ]]; then
   echo "Don't know what to do; exiting, badly."
   exit 1
elif [[ $OSTYPE == darwin* ]]; then

   echo -e "\033[32mUpdate Homebrew\033[0m"
   brew update
   xc=$?; if [ $xc -ne 0 ]; then exit $nc; fi
   echo

   for APP in $APPLIST; do
      echo -e "\033[32mChecking for $APP\033[0m"
      brew ls $APP > /dev/null 2>&1
      xc=$?
      if [ $xc -ne 0 ]; then
         echo -e "\093[32mInstalling $APP\033[0m"
         brew install $APP
      else
         echo -e "\096[32mAttempting to upgrade $APP\033[0m"
         brew upgrade $APP
      fi
      echo
   done

elif [[ $OSTYPE == linux* ]]; then
   VCHDIR="${HOME}/.vch"
   MRGIT="${VCHDIR}/myrepos"
   VCSHGIT="${VCHDIR}/vcsh"
   GITCRYPT="${VCHDIR}/git-crypt"
   DESTDIR="${VCHDIR}"
   mkdir -vp ${VCHDIR} ${MRGIT} ${VCSHGIT} ${DESTDIR}

   if [ ! -d ${MRGIT}/.git ]; then
      git clone git@github.com:joeyh/myrepos.git ${MRGIT}
   else
      git --work-tree=${MRGIT} --git-dir=${MRGIT}/.git pull
   fi
   make -C ${MRGIT} DESTDIR=${DESTDIR} install
   echo

   if [ ! -d ${VCSHGIT}/.git ]; then
      git clone git@github.com:RichiH/vcsh.git ${VCSHGIT}
   else
      git --work-tree=${VCSHGIT} --git-dir=${VCSHGIT}/.git pull
   fi
   make -C ${VCSHGIT} DESTDIR=${DESTDIR} install
   echo

   if [ ! -d ${GITCRYPT}/.git ]; then
      git clone git@github.com:AGWA/git-crypt.git ${GITCRYPT}
   else
      git --work-tree=${GITCRYPT} --git-dir=${GITCRYPT}/.git pull
   fi
   make -C ${GITCRYPT} DESTDIR=${DESTDIR} PREFIX=/usr
   make -C ${GITCRYPT} DESTDIR=${DESTDIR} PREFIX=/usr install
   echo

   export PATH="${HOME}/.vch/usr/bin:$path"
fi

echo ; echo

# IMP - Add key collection/creation
# IMP - Add repo collection/creation

echo ; echo

if [[ $OSTYPE == darwin* ]]; then
   if [ $SHELL == '/bin/tcsh' ]; then
      echo 'set path = ( ${HOME}/.vch/usr/bin $path )'
      echo 'rehash'
   elif [ $SHELL == '/bin/bash' ]; then
      echo 'export PATH="${HOME}/.vch/usr/bin:$path"'
   else
      echo "berp"
   fi
elif [[ $OSTYPE == linux* ]]; then
   if [ $SHELL == '/bin/tcsh' ]; then
      echo 'set path = ( ${HOME}/.vch/usr/bin $path )'
      echo 'rehash'
   elif [ $SHELL == '/bin/bash' ]; then
      echo 'export PATH="${HOME}/.vch/usr/bin:$path"'
   else
      echo "berp"
   fi
fi

echo ; echo

